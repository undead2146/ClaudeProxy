<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Proxy // Metrics</title>
    <style>
        :root {
            --bg: #030303;
            --panel: #0a0a0a;
            --text-main: #e0e0e0;
            --text-muted: #666;

            --sonnet: #ffaa00;
            --haiku: #00ffaa;
            --opus: #aa00ff;
            --error: #ff3333;

            --font-stack: 'SF Mono', 'Segoe UI Mono', 'Roboto Mono', monospace;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text-main);
            font-family: var(--font-stack);
            height: 100vh;
            overflow-y: auto;
            background-image:
                linear-gradient(rgba(20,20,20,0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(20,20,20,0.5) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* HEADER */
        .hud-header {
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, #000, transparent);
            border-bottom: 1px solid #111;
            margin-bottom: 40px;
        }
        .brand {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #fff;
            text-decoration: none;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        button {
            background: #111;
            color: #888;
            border: 1px solid #333;
            padding: 8px 16px;
            font-family: var(--font-stack);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            color: #fff;
            border-color: #666;
            background: #222;
        }

        /* CONTENT */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(10,10,10,0.8);
            border: 1px solid #222;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            border-color: #444;
            background: rgba(15,15,15,0.9);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid #222;
            padding-bottom: 12px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #fff;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #333;
            box-shadow: 0 0 0 1px #333;
        }
        .status-dot.active { background: var(--haiku); box-shadow: 0 0 10px var(--haiku); }
        .status-dot.inactive { background: #333; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .stat-label { color: #666; }
        .stat-value { color: #ccc; font-weight: 600; text-align: right; }

        /* PROGRESS BARS */
        .progress-container {
            margin: 20px 0;
            background: #111;
            height: 4px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--haiku);
            box-shadow: 0 0 10px var(--haiku);
            width: 0%;
            transition: width 1s ease;
        }
        .progress-bar.warn { background: var(--sonnet); box-shadow: 0 0 10px var(--sonnet); }
        .progress-bar.danger { background: var(--error); box-shadow: 0 0 10px var(--error); }

        .quota-display {
            text-align: center;
            margin: 20px 0;
        }
        .big-number {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }
        .sub-text {
            font-size: 12px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-state {
            padding: 40px 0;
            text-align: center;
            color: #444;
            font-style: italic;
        }

    </style>
</head>
<body>

    <div class="hud-header">
        <a href="/dashboard" class="brand">CLAUDE_PROXY // METRICS</a>
        <button onclick="window.location.href='/dashboard'">EXIT DASHBOARD</button>
    </div>

    <div id="container" class="container">
        <div style="grid-column: 1/-1; text-align: center; color: #444; margin-top: 50px;">
            INITIALIZING DATA STREAMS...
        </div>
    </div>

    <script>
        // Auth handling
        const urlParams = new URLSearchParams(window.location.search);
        let apiKey = urlParams.get('key') || localStorage.getItem('proxy_key');

        if (urlParams.get('key')) {
            localStorage.setItem('proxy_key', urlParams.get('key'));
        }

        function getHeaders() {
            const headers = {};
            if (apiKey) headers['x-proxy-key'] = apiKey;
            return headers;
        }

        async function handleAuthError(response) {
            if (response.status === 401) {
                if (!window.authPromptShown) {
                    window.authPromptShown = true;
                    const newKey = prompt("ACCESS DENIED // ENTER KEY:");
                    if (newKey) {
                        apiKey = newKey;
                        localStorage.setItem('proxy_key', newKey);
                        window.location.reload();
                    }
                }
                throw new Error("Auth Failed");
            }
            return response;
        }

        async function loadUsage() {
            try {
                const [copilotRes, antigravityRes] = await Promise.all([
                    fetch('/api/copilot/usage', { headers: getHeaders() }).then(handleAuthError).catch(() => null),
                    fetch('/api/antigravity/health', { headers: getHeaders() }).then(handleAuthError).catch(() => null)
                ]);

                const container = document.getElementById('container');
                let html = '';

                // 1. COPILOT
                if (copilotRes && copilotRes.ok) {
                    const data = await copilotRes.json();
                    const premium = data.quota_snapshots.premium_interactions;
                    const remaining = Math.floor(premium.remaining);
                    const total = premium.entitlement;
                    const percent = premium.percent_remaining;

                    let pClass = '';
                    if (percent < 20) pClass = 'danger';
                    else if (percent < 50) pClass = 'warn';

                    html += `
                        <div class="card" style="border-top: 2px solid #fff">
                            <div class="card-header">
                                <div class="card-title">GITHUB COPILOT</div>
                                <div class="status-dot active"></div>
                            </div>

                            <div class="quota-display">
                                <div class="big-number">${remaining}</div>
                                <div class="sub-text">Interactions Remaining</div>
                            </div>

                            <div class="progress-container">
                                <div class="progress-bar ${pClass}" style="width: ${percent}%"></div>
                            </div>

                            <div class="stat-row">
                                <span class="stat-label">PLAN</span>
                                <span class="stat-value">${data.copilot_plan || 'UNKNOWN'}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">RESET DATE</span>
                                <span class="stat-value">${data.quota_reset_date || 'UNKNOWN'}</span>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="card" style="opacity:0.5">
                            <div class="card-header">
                                <div class="card-title">GITHUB COPILOT</div>
                                <div class="status-dot inactive"></div>
                            </div>
                            <div class="empty-state">OFFLINE / UNCONFIGURED</div>
                        </div>
                    `;
                }

                // 2. ANTIGRAVITY
                if (antigravityRes && antigravityRes.ok) {
                    html += `
                        <div class="card" style="border-top: 2px solid var(--haiku)">
                            <div class="card-header">
                                <div class="card-title" style="color:var(--haiku)">ANTIGRAVITY</div>
                                <div class="status-dot active"></div>
                            </div>

                            <div class="quota-display">
                                <div class="big-number" style="color:var(--haiku)">âˆž</div>
                                <div class="sub-text">Z.AI PROTOCOL</div>
                            </div>

                            <div class="progress-container">
                                <div class="progress-bar" style="width: 100%; background: var(--haiku)"></div>
                            </div>

                            <div class="stat-row">
                                <span class="stat-label">STATUS</span>
                                <span class="stat-value" style="color:var(--haiku)">OPERATIONAL</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">PORT</span>
                                <span class="stat-value">8081</span>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="card" style="opacity:0.5">
                            <div class="card-header">
                                <div class="card-title">ANTIGRAVITY</div>
                                <div class="status-dot inactive"></div>
                            </div>
                            <div class="empty-state">SERVICE OFFLINE</div>
                        </div>
                    `;
                }

                // 3. ANTHROPIC
                html += `
                    <div class="card" style="border-top: 2px solid var(--sonnet)">
                        <div class="card-header">
                            <div class="card-title" style="color:var(--sonnet)">ANTHROPIC</div>
                            <div class="status-dot active"></div>
                        </div>

                        <div class="quota-display">
                            <div class="big-number" style="color:var(--sonnet)">API</div>
                            <div class="sub-text">DIRECT CONNECTION</div>
                        </div>

                        <div class="progress-container">
                            <div class="progress-bar" style="width: 100%; background: var(--sonnet); opacity: 0.3"></div>
                        </div>

                        <div class="stat-row">
                            <span class="stat-label">AUTH</span>
                            <span class="stat-value">OAUTH 2.0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">TRACKING</span>
                            <span class="stat-value">EXTERNAL</span>
                        </div>
                    </div>
                `;

                container.innerHTML = html;

            } catch (e) {
                document.getElementById('container').innerHTML = `<div class="empty-state" style="color:var(--error)">ERROR: ${e.message}</div>`;
            }
        }

        loadUsage();
        setInterval(loadUsage, 10000);
    </script>
</body>
</html>
